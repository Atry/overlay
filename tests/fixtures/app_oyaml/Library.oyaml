# Library.oyaml â€” business logic, decoupled from any specific FFI implementation.
# All FFI references use [FFI, Xxx] which resolves to abstract declarations below.
# Concrete FFI implementations are provided at composition time (e.g. stdlib_ffi/FFI.py).

FFI:
  SqliteConnectAndExecuteScript:
    database_path: []
    setup_sql: []
    connection: []
  SqliteScalarQuery:
    connection: []
    sql: []
    scalar: []
  SqliteRowQuery:
    connection: []
    sql: []
    parameters: []
    row: []
  TupleWrap:
    element: []
    wrapped: []
  GetItem:
    sequence: []
    index: []
    element: []
  HttpRequestExtern:
    request: []
  ExtractUserId:
    request: []
    path_separator: []
    user_id: []
  FormatResponse:
    response_template: []
    user_count: []
    current_user_name: []
    response_body: []
  HttpSendResponse:
    request: []
    status_code: []
    body: []
    written: []
  HttpHandlerClass:
    RequestScope: []
    handler_class: []
  HttpServerCreate:
    host: []
    port: []
    handler_class: []
    server: []

SQLiteDatabase:
  database_path: []
  setup_sql: []
  _db:
    - [FFI, SqliteConnectAndExecuteScript]
    - database_path: [database_path]
      setup_sql: [setup_sql]
  connection: [_db, connection]

UserRepository:
  connection: []
  user_count_sql: []
  User:
    user_id: []
    name: []
  _count:
    - [FFI, SqliteScalarQuery]
    - connection: [connection]
      sql: [user_count_sql]
  user_count: [_count, scalar]
  RequestScope:
    user_id: []
    user_query_sql: []
    _params:
      - [FFI, TupleWrap]
      - element: [user_id]
    _row:
      - [FFI, SqliteRowQuery]
      - connection: [connection]
        sql: [user_query_sql]
        parameters: [_params, wrapped]
    _identifier:
      - [FFI, GetItem]
      - sequence: [_row, row]
        index: 0
    _name:
      - [FFI, GetItem]
      - sequence: [_row, row]
        index: 1
    current_user:
      user_id: [_identifier, element]
      name: [_name, element]
    current_user_name: [current_user, name]

HttpHandlers:
  user_count: []
  RequestScope:
    - [FFI, HttpRequestExtern]
    - [FFI, ExtractUserId]
    - [FFI, HttpSendResponse]
    - request: []
      path_separator: []
      response_template: []
      status_code: 200
      current_user_name: []
      _format:
        - [FFI, FormatResponse]
        - response_template: [response_template]
          user_count: [user_count]
          current_user_name: [current_user_name]
      response_body: [_format, response_body]
      body: [response_body]
      # Qualified this: fails loudly if HttpSendResponse is not composed,
      # unlike `written: []` which silently creates an empty scope.
      response: [RequestScope, ~, written]

NetworkServer:
  - [FFI, HttpServerCreate]
  - host: []
    port: []
    RequestScope: []
    _handler:
      - [FFI, HttpHandlerClass]
      - RequestScope: [RequestScope]
    handler_class: [_handler, handler_class]
