# Expression Problem Demo
# Ported from Wang & Oliveira (2016), "The Expression Problem, Trivially!"
#
# The Expression Problem: extend a data type with both new cases and
# new operations, without modifying existing code.
#
# MixinCalculus solves this via composition (⊕). Each component below
# is independently defined; they compose freely at the end.
#
# Each operation module declares placeholder properties on sub-expressions
# (e.g., outcome: {} on left/right). These act as structural type
# annotations — they state what the operation expects, and are overridden
# by concrete instances.

# ============================================================
# Component 1: Base expression types + evaluation operation
# ============================================================

Base:
  expression:
    Literal:
      magnitude: {}
    Addition:
      left: {}
      right: {}
  evaluation:
    Literal:
      - [Base, ~, expression, Literal]
      - outcome:
          - [Literal, ~, magnitude]
    Addition:
      - [Base, ~, expression, Addition]
      - left:
          outcome: {}
        right:
          outcome: {}
        outcome:
          left:
            - [Addition, ~, left, outcome]
          right:
            - [Addition, ~, right, outcome]

# ============================================================
# Component 2: Display operation (new operation, Base untouched)
# ============================================================

WithDisplay:
  display:
    Literal:
      - [Base, expression, Literal]
      - representation:
          literal:
            - [Literal, ~, magnitude]
    Addition:
      - [Base, expression, Addition]
      - left:
          representation: {}
        right:
          representation: {}
        representation:
          addition:
            left:
              - [Addition, ~, left, representation]
            right:
              - [Addition, ~, right, representation]

# ============================================================
# Component 3: Negation case (new case, Base and Display untouched)
# ============================================================

WithNegation:
  expression:
    Negation:
      operand: {}
  evaluation:
    Negation:
      - [WithNegation, ~, expression, Negation]
      - operand:
          outcome: {}
        outcome:
          negated:
            - [Negation, ~, operand, outcome]
  display:
    Negation:
      - [WithNegation, ~, expression, Negation]
      - operand:
          representation: {}
        representation:
          negation:
            - [Negation, ~, operand, representation]

# ============================================================
# Compose all components: Base ⊕ WithDisplay ⊕ WithNegation
# ============================================================

Full:
  - [Base]
  - [WithDisplay]
  - [WithNegation]

# ============================================================
# Tests
# ============================================================

# Test: Literal(a) — evaluation and display
# Expected outcome: {a: {}}
# Expected representation: {literal: {a: {}}}
test_literal:
  - [Full, evaluation, Literal]
  - [Full, display, Literal]
  - magnitude:
      a: {}

# Test: Addition(Literal(a), Literal(b)) — evaluation and display
# Expected outcome: {left: {a: {}}, right: {b: {}}}
# Expected representation: {addition: {left: {literal: {a: {}}}, right: {literal: {b: {}}}}}
test_addition:
  - [Full, evaluation, Addition]
  - [Full, display, Addition]
  - left:
      - [Full, evaluation, Literal]
      - [Full, display, Literal]
      - magnitude:
          a: {}
    right:
      - [Full, evaluation, Literal]
      - [Full, display, Literal]
      - magnitude:
          b: {}

# Test: Negation(Literal(x)) — evaluation and display (uses the new case)
# Expected outcome: {negated: {x: {}}}
# Expected representation: {negation: {literal: {x: {}}}}
test_negation:
  - [Full, evaluation, Negation]
  - [Full, display, Negation]
  - operand:
      - [Full, evaluation, Literal]
      - [Full, display, Literal]
      - magnitude:
          x: {}

# Test: Addition(Negation(Literal(a)), Literal(b)) — mixed old + new cases
# Expected outcome: {left: {negated: {a: {}}}, right: {b: {}}}
# Expected representation: {addition: {left: {negation: {literal: {a: {}}}}, right: {literal: {b: {}}}}}
test_nested:
  - [Full, evaluation, Addition]
  - [Full, display, Addition]
  - left:
      - [Full, evaluation, Negation]
      - [Full, display, Negation]
      - operand:
          - [Full, evaluation, Literal]
          - [Full, display, Literal]
          - magnitude:
              a: {}
    right:
      - [Full, evaluation, Literal]
      - [Full, display, Literal]
      - magnitude:
          b: {}
